{
  "name": "System - Client Onboarding v2",
  "nodes": [
    {
      "id": "webhook-trigger",
      "name": "Webhook: Onboard Client",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "onboard-client-v2",
      "parameters": {
        "httpMethod": "POST",
        "path": "onboard-client",
        "responseMode": "responseNode",
        "options": {}
      }
    },
    {
      "id": "check-task-in-db",
      "name": "Check Task in DynamoDB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [350, 300],
      "parameters": {
        "method": "GET",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/clients/by-task/{{ $json.body.task_id }}",
        "authentication": "none",
        "options": {}
      }
    },
    {
      "id": "check-dedupe",
      "name": "Task Already Onboarded?",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "parameters": {
        "mode": "runOnceForAllItems",
        "language": "javaScript",
        "jsCode": "// Check if task exists and set routing flag\nconst data = $input.first().json;\nconst exists = data.exists === true;\n\n// Return item with explicit isNew flag\nreturn [{\n  json: {\n    ...data,\n    isNew: !exists\n  }\n}];"
      }
    },
    {
      "id": "route-dedup",
      "name": "Route By Dedup Result",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [580, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.isNew }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "dedupe-response",
      "name": "Already Onboarded Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [700, 500],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Client already onboarded for this ClickUp task\", \"task_id\": \"{{ $('Webhook: Onboard Client').item.json.body.task_id }}\", \"existing_client_id\": \"{{ $json.client.client_id }}\" }",
        "options": {}
      }
    },
    {
      "id": "claim-task",
      "name": "Claim Task in DynamoDB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [700, 300],
      "parameters": {
        "method": "PUT",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/clients/claim/{{ $('Webhook: Onboard Client').item.json.body.task_id }}",
        "authentication": "none",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "{ \"status\": \"claiming\" }",
        "options": {}
      }
    },
    {
      "id": "check-claim-result",
      "name": "Check Claim Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [760, 300],
      "parameters": {
        "mode": "runOnceForAllItems",
        "language": "javaScript",
        "jsCode": "// Check if claim was successful\nconst data = $input.first().json;\nconst claimed = data.claimed === true;\n\n// Return item with explicit claimSuccess flag\nreturn [{\n  json: {\n    ...data,\n    claimSuccess: claimed\n  }\n}];"
      }
    },
    {
      "id": "route-claim-result",
      "name": "Route By Claim Result",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [840, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.claimSuccess }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "claim-failed-response",
      "name": "Claim Failed Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 500],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Task already being processed by another execution\", \"task_id\": \"{{ $('Webhook: Onboard Client').item.json.body.task_id }}\" }",
        "options": {}
      }
    },
    {
      "id": "check-status",
      "name": "Check If Onboarding Status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [820, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $('Webhook: Onboard Client').item.json.body.history_items?.[0]?.after?.status || $('Webhook: Onboard Client').item.json.body.status?.status || '' }}",
              "rightValue": "onboarding",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      }
    },
    {
      "id": "fetch-task",
      "name": "Fetch ClickUp Task",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [920, 300],
      "parameters": {
        "method": "GET",
        "url": "=https://api.clickup.com/api/v2/task/{{ $('Webhook: Onboard Client').item.json.body.task_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "KQ4DCkxv3kBoRgK1",
          "name": "System ClickUp API"
        }
      }
    },
    {
      "id": "extract-client-info",
      "name": "Extract Client Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1140, 300],
      "parameters": {
        "jsCode": "// Extract custom fields from ClickUp task\nconst task = $input.first().json;\nconst customFields = task.custom_fields || [];\n\n// Field IDs from ClickUp\nconst FIELD_IDS = {\n  client_id: '8a92110c-90e6-43bc-9573-ff01a39c39d5',\n  reply_api_key: '7be3268d-ced7-4895-9026-9ea72437a8af',\n  reply_user: 'e7cddd23-549d-46e7-a46f-ef97949f0919',\n  reply_password: '59e1624b-318c-491d-a4cd-75332fdaad0e',\n  clickup_api_key: '4c99c4ad-cc34-4731-9cb2-b53120218c82',\n  company_name: '752f908a-9338-40b8-9737-9405267da718'\n};\n\n// UUID v4 generator (crypto not available in n8n)\nfunction generateUUID() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\n// Extract values\nconst getFieldValue = (id) => {\n  const field = customFields.find(f => f.id === id);\n  return field?.value || '';\n};\n\nconst companyName = getFieldValue(FIELD_IDS.company_name);\nconst replyApiKey = getFieldValue(FIELD_IDS.reply_api_key);\nconst replyUser = getFieldValue(FIELD_IDS.reply_user);\nconst replyPassword = getFieldValue(FIELD_IDS.reply_password);\nconst clickupApiKey = getFieldValue(FIELD_IDS.clickup_api_key);\n\n// Validate required fields (client_id is NO LONGER required from ClickUp)\nif (!replyApiKey || !replyUser || !replyPassword || !clickupApiKey) {\n  throw new Error(`Missing required fields. Found: reply_api_key=${!!replyApiKey}, reply_user=${!!replyUser}, reply_password=${!!replyPassword}, clickup_api_key=${!!clickupApiKey}`);\n}\n\n// GENERATE UUID for client_id - DynamoDB is now the source of truth\nconst clientId = generateUUID();\n\nconsole.log(`ðŸ†” Generated client_id: ${clientId}`);\n\nreturn {\n  json: {\n    client_id: clientId,\n    client_id_field_id: FIELD_IDS.client_id,\n    client_name: companyName || task.name || clientId,\n    reply_api_key: replyApiKey,\n    reply_io_user: replyUser,\n    reply_io_password: replyPassword,\n    clickup_api_key: clickupApiKey,\n    clickup_task_id: task.id,\n    github_owner: 'byronmartinez-ballastlane',\n    github_repo: 'qtalo-n8n-testing',\n    templates_path: 'templates'\n  }\n};"
      }
    },
    {
      "id": "check-if-exists",
      "name": "Check If Client Exists",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 300],
      "parameters": {
        "method": "GET",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/clients/{{ $json.client_id }}",
        "authentication": "none",
        "options": {}
      },
      "continueOnFail": true
    },
    {
      "id": "validate-client-status",
      "name": "Validate Client Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300],
      "parameters": {
        "jsCode": "// Check if client already exists and is active\nconst clientInfo = $('Extract Client Info').first().json;\nconst existingClient = $input.first().json;\n\n// If client exists and is active, skip onboarding\nif (existingClient.client_id && existingClient.status === 'active') {\n  console.log(`â­ï¸ Client ${clientInfo.client_id} already exists with status 'active' - skipping onboarding`);\n  return [{\n    json: {\n      ...clientInfo,\n      skip: true,\n      reason: 'Client already onboarded',\n      existing_client: existingClient\n    }\n  }];\n}\n\n// Client doesn't exist or is not active, proceed with onboarding\nconsole.log(`âœ… Proceeding with onboarding for ${clientInfo.client_id}`);\nreturn [{\n  json: {\n    ...clientInfo,\n    skip: false\n  }\n}];"
      }
    },
    {
      "id": "should-onboard",
      "name": "Should Onboard?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1560, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.skip }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "already-onboarded-response",
      "name": "Build Already Onboarded Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 500],
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nreturn {\n  json: {\n    success: true,\n    message: 'Client already onboarded',\n    client_id: data.client_id,\n    client_name: data.client_name,\n    existing_client: data.existing_client\n  }\n};"
      }
    },
    {
      "id": "create-client-aws",
      "name": "Create Client in AWS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 300],
      "parameters": {
        "method": "PUT",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/clients/{{ $json.client_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"client_name\": \"{{ $json.client_name }}\",\n  \"status\": \"provisioning\",\n  \"template_version\": \"2.0.0\",\n  \"workflow_ids\": {}\n}",
        "options": {}
      }
    },
    {
      "id": "store-credentials-aws",
      "name": "Store Credentials in AWS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2000, 300],
      "parameters": {
        "method": "PUT",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/credentials/{{ $('Extract Client Info').item.json.client_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"reply_api_key\": \"{{ $('Extract Client Info').item.json.reply_api_key }}\",\n  \"reply_io_user\": \"{{ $('Extract Client Info').item.json.reply_io_user }}\",\n  \"reply_io_password\": \"{{ $('Extract Client Info').item.json.reply_io_password }}\",\n  \"clickup_api_key\": \"{{ $('Extract Client Info').item.json.clickup_api_key }}\"\n}",
        "options": {}
      }
    },
    {
      "id": "update-clickup-client-id",
      "name": "Update ClickUp Client ID",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2000, 420],
      "continueOnFail": true,
      "parameters": {
        "method": "POST",
        "url": "=https://api.clickup.com/api/v2/task/{{ $('Extract Client Info').first().json.clickup_task_id }}/field/{{ $('Extract Client Info').first().json.client_id_field_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "={{ $('Extract Client Info').first().json.clickup_api_key }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ value: $('Extract Client Info').first().json.client_id }) }}",
        "options": {}
      }
    },
    {
      "id": "create-clickup-credential",
      "name": "Create ClickUp Credential",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 200],
      "parameters": {
        "method": "POST",
        "url": "https://qtalospace.app.n8n.cloud/api/v1/credentials",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ name: $('Extract Client Info').item.json.client_name + ' - ClickUp API', type: 'httpHeaderAuth', data: { name: 'Authorization', value: $('Extract Client Info').item.json.clickup_api_key } }) }}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      }
    },
    {
      "id": "transfer-clickup-credential",
      "name": "Transfer ClickUp Credential",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 400],
      "parameters": {
        "method": "PUT",
        "url": "=https://qtalospace.app.n8n.cloud/api/v1/credentials/{{ $('Create ClickUp Credential').item.json.id }}/transfer",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"destinationProjectId\": \"BFIDAvXOISVZh7tb\"\n}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "create-reply-credential",
      "name": "Create Reply Credential",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 500],
      "parameters": {
        "method": "POST",
        "url": "https://qtalospace.app.n8n.cloud/api/v1/credentials",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ name: $('Extract Client Info').item.json.client_name + ' - Reply API', type: 'httpHeaderAuth', data: { name: 'X-Api-Key', value: $('Extract Client Info').item.json.reply_api_key } }) }}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      }
    },
    {
      "id": "transfer-reply-credential",
      "name": "Transfer Reply Credential",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1010, 600],
      "parameters": {
        "method": "PUT",
        "url": "=https://qtalospace.app.n8n.cloud/api/v1/credentials/{{ $('Create Reply Credential').item.json.id }}/transfer",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"destinationProjectId\": \"BFIDAvXOISVZh7tb\"\n}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "merge-credential-info",
      "name": "Merge Credential Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1230, 300],
      "parameters": {
        "jsCode": "// Merge credential info with client info\nconst clientInfo = $('Extract Client Info').first().json;\nconst clickupCred = $('Create ClickUp Credential').first().json;\nconst replyCred = $('Create Reply Credential').first().json;\n\nreturn [{\n  json: {\n    ...clientInfo,\n    clickup_credential_id: clickupCred.id,\n    clickup_credential_name: clickupCred.name,\n    reply_credential_id: replyCred.id,\n    reply_credential_name: replyCred.name\n  }\n}];"
      }
    },
    {
      "id": "list-templates",
      "name": "List Template Files",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [1340, 300],
      "parameters": {
        "resource": "file",
        "operation": "list",
        "owner": {
          "__rl": true,
          "mode": "name",
          "value": "={{ $('Extract Client Info').item.json.github_owner }}"
        },
        "repository": {
          "__rl": true,
          "mode": "name",
          "value": "={{ $('Extract Client Info').item.json.github_repo }}"
        },
        "filePath": "=/{{ $('Extract Client Info').item.json.templates_path }}"
      },
      "credentials": {
        "githubApi": {
          "id": "Q6oSPWOEORCm73TJ",
          "name": "GitHub API - Qtalo"
        }
      }
    },
    {
      "id": "filter-templates",
      "name": "Filter JSON Templates",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [1560, 300],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "filter-json",
              "operator": {
                "type": "string",
                "operation": "endsWith"
              },
              "leftValue": "={{ $json.name }}",
              "rightValue": ".template.json"
            }
          ]
        }
      }
    },
    {
      "id": "get-template-content",
      "name": "Get Template Content",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "position": [1780, 300],
      "parameters": {
        "resource": "file",
        "operation": "get",
        "owner": {
          "__rl": true,
          "mode": "name",
          "value": "={{ $('Extract Client Info').item.json.github_owner }}"
        },
        "repository": {
          "__rl": true,
          "mode": "name",
          "value": "={{ $('Extract Client Info').item.json.github_repo }}"
        },
        "filePath": "={{ $json.path }}",
        "asBinaryProperty": false,
        "additionalParameters": {}
      },
      "credentials": {
        "githubApi": {
          "id": "Q6oSPWOEORCm73TJ",
          "name": "GitHub API - Qtalo"
        }
      }
    },
    {
      "id": "decode-and-inject",
      "name": "Decode & Inject Client Values",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 300],
      "parameters": {
        "jsCode": "// Decode base64 content and inject client values for ALL templates\nconst clientInfo = $('Merge Credential Info').first().json;\nconst items = $input.all();\n\nconst results = items.map(item => {\n  const base64Content = item.json.content;\n  const fileName = item.json.name;\n\n  // Decode base64\n  const jsonContent = Buffer.from(base64Content, 'base64').toString('utf8');\n  let workflow = JSON.parse(jsonContent);\n\n  // Determine template type from filename\n  let templateKey = 'unknown';\n  if (fileName.includes('phase1')) templateKey = 'phase1';\n  else if (fileName.includes('phase2')) templateKey = 'phase2';\n  else if (fileName.includes('phase3')) templateKey = 'phase3';\n  else if (fileName.includes('orchestrator')) templateKey = 'orchestrator';\n\n  // Update workflow name\n  const clientIdLower = clientInfo.client_id.toLowerCase();\n  const clientIdUpper = clientInfo.client_id.toUpperCase().replace(/-/g, '_');\n  workflow.name = `${clientInfo.client_name} - ${workflow.name.replace(/^.*? - /, '')}`;\n\n  // Inject client values into nodes\n  workflow.nodes = workflow.nodes.map(node => {\n    if (node.parameters) {\n      let params = JSON.stringify(node.parameters);\n      // CLIENT_ID lowercase for AWS Secrets Manager lookups\n      params = params.replace(/\\{\\{CLIENT_ID\\}\\}/g, clientIdLower);\n      params = params.replace(/\\{\\{CLIENT_NAME\\}\\}/g, clientInfo.client_name);\n      params = params.replace(/\\$vars\\.CLIENT_REPLY_API_KEY/g, `$vars.${clientIdUpper}_REPLY_API_KEY`);\n      params = params.replace(/\\$vars\\.CLIENT_CLICKUP_API_KEY/g, `$vars.${clientIdUpper}_CLICKUP_API_KEY`);\n      node.parameters = JSON.parse(params);\n    }\n    \n    // Replace credential placeholders with actual credential IDs\n    if (node.credentials) {\n      for (const [key, value] of Object.entries(node.credentials)) {\n        if (value.id === '{{CLICKUP_CREDENTIAL_ID}}' || value.name === '{{CLICKUP_CREDENTIAL_NAME}}') {\n          value.id = clientInfo.clickup_credential_id;\n          value.name = clientInfo.clickup_credential_name;\n        }\n        if (value.id === '{{REPLY_CREDENTIAL_ID}}' || value.name === '{{REPLY_CREDENTIAL_NAME}}') {\n          value.id = clientInfo.reply_credential_id;\n          value.name = clientInfo.reply_credential_name;\n        }\n      }\n    }\n    \n    return node;\n  });\n\n  delete workflow.id;\n\n  return {\n    json: {\n      template_key: templateKey,\n      file_name: fileName,\n      workflow: workflow,\n      client_id: clientInfo.client_id,\n      client_name: clientInfo.client_name\n    }\n  };\n});\n\nreturn results;"
      }
    },
    {
      "id": "create-workflow",
      "name": "Create Workflow in n8n",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [2220, 300],
      "parameters": {
        "operation": "create",
        "workflowObject": "={{ $json.workflow.toJsonString() }}",
        "requestOptions": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      }
    },
    {
      "id": "transfer-to-project",
      "name": "Transfer to Qtalo Project",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2440, 300],
      "parameters": {
        "method": "PUT",
        "url": "=https://qtalospace.app.n8n.cloud/api/v1/workflows/{{ $json.id }}/transfer",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"destinationProjectId\": \"BFIDAvXOISVZh7tb\"\n}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "collect-workflow-ids",
      "name": "Collect Workflow IDs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 300],
      "parameters": {
        "jsCode": "// Collect all created workflow IDs from the Create Workflow node\nconst createItems = $('Create Workflow in n8n').all();\nconst decodeItems = $('Decode & Inject Client Values').all();\nconst extractInfo = $('Extract Client Info').first().json;\n\nconst workflowIds = {};\nconst clientId = decodeItems[0]?.json.client_id;\nconst clientName = decodeItems[0]?.json.client_name;\n\ncreateItems.forEach((item, index) => {\n  const templateKey = decodeItems[index]?.json.template_key;\n  const workflowId = item.json.id;\n  \n  if (templateKey && workflowId) {\n    workflowIds[templateKey] = workflowId;\n  }\n});\n\nreturn [{\n  json: {\n    client_id: clientId,\n    client_name: clientName,\n    workflow_ids: workflowIds,\n    clickup_task_id: extractInfo.clickup_task_id\n  }\n}];"
      }
    },
    {
      "id": "update-orchestrator-phase-ids",
      "name": "Update Orchestrator with Phase IDs",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2770, 300],
      "parameters": {
        "method": "GET",
        "url": "=https://qtalospace.app.n8n.cloud/api/v1/workflows/{{ $json.workflow_ids.orchestrator }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      }
    },
    {
      "id": "inject-phase-ids-to-orchestrator",
      "name": "Inject Phase IDs to Orchestrator",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2880, 200],
      "parameters": {
        "jsCode": "// Get the orchestrator workflow and inject Phase workflow IDs\nconst orchestratorWorkflow = $input.first().json;\nconst collectedIds = $('Collect Workflow IDs').first().json;\nconst workflowIds = collectedIds.workflow_ids;\n\n// Get the Phase workflow IDs\nconst phase1Id = workflowIds.phase1 || '';\nconst phase2Id = workflowIds.phase2 || '';\nconst phase3Id = workflowIds.phase3 || '';\n\nconsole.log('Injecting Phase IDs into Orchestrator:');\nconsole.log('- Phase 1:', phase1Id);\nconsole.log('- Phase 2:', phase2Id);\nconsole.log('- Phase 3:', phase3Id);\n\n// Update nodes that have placeholder workflow IDs\nconst updatedNodes = orchestratorWorkflow.nodes.map(node => {\n  if (node.parameters && node.parameters.workflowId) {\n    // Replace Phase workflow ID placeholders\n    if (node.parameters.workflowId === '{{PHASE1_WORKFLOW_ID}}' || node.name.includes('Phase 1')) {\n      node.parameters.workflowId = phase1Id;\n      console.log(`Updated ${node.name} with Phase 1 ID: ${phase1Id}`);\n    }\n    if (node.parameters.workflowId === '{{PHASE2_WORKFLOW_ID}}' || node.name.includes('Phase 2')) {\n      node.parameters.workflowId = phase2Id;\n      console.log(`Updated ${node.name} with Phase 2 ID: ${phase2Id}`);\n    }\n    if (node.parameters.workflowId === '{{PHASE3_WORKFLOW_ID}}' || node.name.includes('Phase 3')) {\n      node.parameters.workflowId = phase3Id;\n      console.log(`Updated ${node.name} with Phase 3 ID: ${phase3Id}`);\n    }\n  }\n  return node;\n});\n\n// Prepare updated workflow for API\nconst updatedWorkflow = {\n  name: orchestratorWorkflow.name,\n  nodes: updatedNodes,\n  connections: orchestratorWorkflow.connections,\n  settings: orchestratorWorkflow.settings || { executionOrder: 'v1' }\n};\n\nreturn [{\n  json: {\n    orchestrator_id: workflowIds.orchestrator,\n    updated_workflow: updatedWorkflow,\n    workflow_ids: workflowIds,\n    client_id: collectedIds.client_id,\n    client_name: collectedIds.client_name,\n    clickup_task_id: collectedIds.clickup_task_id\n  }\n}];"
      }
    },
    {
      "id": "save-updated-orchestrator",
      "name": "Save Updated Orchestrator",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2990, 200],
      "parameters": {
        "method": "PUT",
        "url": "=https://qtalospace.app.n8n.cloud/api/v1/workflows/{{ $json.orchestrator_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "n8nApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.updated_workflow) }}",
        "options": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      }
    },
    {
      "id": "prepare-for-activation",
      "name": "Prepare for Activation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3100, 200],
      "parameters": {
        "jsCode": "// Pass through the collected data for activation step\nconst injectedData = $('Inject Phase IDs to Orchestrator').first().json;\n\nreturn [{\n  json: {\n    client_id: injectedData.client_id,\n    client_name: injectedData.client_name,\n    workflow_ids: injectedData.workflow_ids,\n    clickup_task_id: injectedData.clickup_task_id\n  }\n}];"
      }
    },
    {
      "id": "activate-orchestrator",
      "name": "Activate Orchestrator",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [3210, 200],
      "parameters": {
        "resource": "workflow",
        "operation": "activate",
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.workflow_ids.orchestrator }}"
        },
        "requestOptions": {}
      },
      "credentials": {
        "n8nApi": {
          "id": "EaOQcyWDYyvGbbr7",
          "name": "n8n API - Qtalo"
        }
      },
      "continueOnFail": true
    },
    {
      "id": "update-client-aws",
      "name": "Update Client Status in AWS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3320, 200],
      "parameters": {
        "method": "PUT",
        "url": "=https://zxn1hyal26.execute-api.us-east-1.amazonaws.com/prod/clients/{{ $('Prepare for Activation').item.json.client_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ status: 'active', workflow_ids: $('Prepare for Activation').item.json.workflow_ids || {}, clickup_task_id: $('Prepare for Activation').item.json.clickup_task_id, deployed_at: new Date().toISOString() }) }}",
        "options": {}
      }
    },
    {
      "id": "success-response",
      "name": "Build Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [3430, 200],
      "parameters": {
        "mode": "raw",
        "options": {},
        "jsonOutput": "={{ JSON.stringify({ status: 'success', message: 'Client onboarded successfully', client_id: $('Prepare for Activation').item.json.client_id, client_name: $('Prepare for Activation').item.json.client_name, workflow_ids: $('Prepare for Activation').item.json.workflow_ids || {} }) }}"
      }
    },
    {
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [3540, 200],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      }
    }
  ],
  "connections": {
    "Webhook: Onboard Client": {
      "main": [[{ "node": "Check Task in DynamoDB", "type": "main", "index": 0 }]]
    },
    "Check Task in DynamoDB": {
      "main": [[{ "node": "Task Already Onboarded?", "type": "main", "index": 0 }]]
    },
    "Task Already Onboarded?": {
      "main": [[{ "node": "Route By Dedup Result", "type": "main", "index": 0 }]]
    },
    "Route By Dedup Result": {
      "main": [
        [{ "node": "Claim Task in DynamoDB", "type": "main", "index": 0 }],
        [{ "node": "Already Onboarded Response", "type": "main", "index": 0 }]
      ]
    },
    "Claim Task in DynamoDB": {
      "main": [[{ "node": "Check Claim Result", "type": "main", "index": 0 }]]
    },
    "Check Claim Result": {
      "main": [[{ "node": "Route By Claim Result", "type": "main", "index": 0 }]]
    },
    "Route By Claim Result": {
      "main": [
        [{ "node": "Check If Onboarding Status", "type": "main", "index": 0 }],
        [{ "node": "Claim Failed Response", "type": "main", "index": 0 }]
      ]
    },
    "Check If Onboarding Status": {
      "main": [[{ "node": "Fetch ClickUp Task", "type": "main", "index": 0 }]]
    },
    "Fetch ClickUp Task": {
      "main": [[{ "node": "Extract Client Info", "type": "main", "index": 0 }]]
    },
    "Extract Client Info": {
      "main": [[{ "node": "Check If Client Exists", "type": "main", "index": 0 }]]
    },
    "Check If Client Exists": {
      "main": [[{ "node": "Validate Client Status", "type": "main", "index": 0 }]]
    },
    "Validate Client Status": {
      "main": [[{ "node": "Should Onboard?", "type": "main", "index": 0 }]]
    },
    "Should Onboard?": {
      "main": [
        [{ "node": "Create Client in AWS", "type": "main", "index": 0 }],
        [{ "node": "Build Already Onboarded Response", "type": "main", "index": 0 }]
      ]
    },
    "Build Already Onboarded Response": {
      "main": [[{ "node": "Respond to Webhook", "type": "main", "index": 0 }]]
    },
    "Create Client in AWS": {
      "main": [[
        { "node": "Store Credentials in AWS", "type": "main", "index": 0 },
        { "node": "Update ClickUp Client ID", "type": "main", "index": 0 }
      ]]
    },
    "Store Credentials in AWS": {
      "main": [[{ "node": "Create ClickUp Credential", "type": "main", "index": 0 }]]
    },
    "Create ClickUp Credential": {
      "main": [[{ "node": "Transfer ClickUp Credential", "type": "main", "index": 0 }]]
    },
    "Transfer ClickUp Credential": {
      "main": [[{ "node": "Create Reply Credential", "type": "main", "index": 0 }]]
    },
    "Create Reply Credential": {
      "main": [[{ "node": "Transfer Reply Credential", "type": "main", "index": 0 }]]
    },
    "Transfer Reply Credential": {
      "main": [[{ "node": "Merge Credential Info", "type": "main", "index": 0 }]]
    },
    "Merge Credential Info": {
      "main": [[{ "node": "List Template Files", "type": "main", "index": 0 }]]
    },
    "List Template Files": {
      "main": [[{ "node": "Filter JSON Templates", "type": "main", "index": 0 }]]
    },
    "Filter JSON Templates": {
      "main": [[{ "node": "Get Template Content", "type": "main", "index": 0 }]]
    },
    "Get Template Content": {
      "main": [[{ "node": "Decode & Inject Client Values", "type": "main", "index": 0 }]]
    },
    "Decode & Inject Client Values": {
      "main": [[{ "node": "Create Workflow in n8n", "type": "main", "index": 0 }]]
    },
    "Create Workflow in n8n": {
      "main": [[{ "node": "Transfer to Qtalo Project", "type": "main", "index": 0 }]]
    },
    "Transfer to Qtalo Project": {
      "main": [[{ "node": "Collect Workflow IDs", "type": "main", "index": 0 }]]
    },
    "Collect Workflow IDs": {
      "main": [[{ "node": "Update Orchestrator with Phase IDs", "type": "main", "index": 0 }]]
    },
    "Update Orchestrator with Phase IDs": {
      "main": [[{ "node": "Inject Phase IDs to Orchestrator", "type": "main", "index": 0 }]]
    },
    "Inject Phase IDs to Orchestrator": {
      "main": [[{ "node": "Save Updated Orchestrator", "type": "main", "index": 0 }]]
    },
    "Save Updated Orchestrator": {
      "main": [[{ "node": "Prepare for Activation", "type": "main", "index": 0 }]]
    },
    "Prepare for Activation": {
      "main": [[{ "node": "Activate Orchestrator", "type": "main", "index": 0 }]]
    },
    "Activate Orchestrator": {
      "main": [[{ "node": "Update Client Status in AWS", "type": "main", "index": 0 }]]
    },
    "Update Client Status in AWS": {
      "main": [[{ "node": "Build Success Response", "type": "main", "index": 0 }]]
    },
    "Build Success Response": {
      "main": [[{ "node": "Respond to Webhook", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
